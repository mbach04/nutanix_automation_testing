---
- name: test the nutanix api
  hosts: localhost
  vars:
    - cluster_ip: 172.29.170.95
    - api_v2: "https://{{ cluster_ip }}:9440/PrismGateway/services/rest/v2.0"
    - api_v3: "https://{{ cluster_ip }}:9440/api/nutanix/v3"
    - prism_user: admin
    - cluster_uuid: 00056e15-0223-d74a-497a-ecf4bbd9b8f0
    - subnet_uuid: 3684e505-7f21-4ee2-8550-cc34b1908de7
    - rhel_iso_uuid: ffdf0075-feb6-49d4-9c4b-3e836901b225
  vars_prompt:
    - name: "prism_password"
      prompt: "Enter prism password"
      private: yes
  tasks:
    # https://172.29.170.95:9440/PrismGateway/services/rest/v2.0/virtual_disks/?count=10
    - name: Test the api disks end point
      uri:
        url: "{{ api_v2 }}/virtual_disks"
        body: "count=10"
        method: GET
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        user: "{{ prism_user }}"
        password: "{{ prism_password }}"
        status_code: 200
      register: json_disks_result
      ignore_errors: yes
    
    - name: Dump the disks call result
      debug:
        var: json_disks_result.json

    - name: Get a list of VMs
      uri:
        url: "{{ api_v2 }}/vms"
        body: "count=10"
        method: GET
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        user: "{{ prism_user }}"
        password: "{{ prism_password }}"
        status_code: 200
      register: json_vms_result

    - name: debug the json vms results, dump it all
      debug:
        msg: "{{ json_vms_result.json }}"

    - name: debug the json vms results, grab the uuid of the first vm returned
      debug:
        # var: json_vms_results.json.entities.uuid
        msg: "{{ json_vms_result.json.entities[0].uuid }}"

    - name: Create a basic VM
      uri:
        url: "{{ api_v3 }}/vms"
        body: "{{ lookup('file','vm-def.json') }}"
        method: POST
        validate_certs: no
        force_basic_auth: yes
        # HEADER_Content-Type: "application/json" #test this, seems we need it at times and others we don't?
        body_format: json
        user: "{{ prism_user }}"
        password: "{{ prism_password }}"
        status_code: 202
      register: json_create_result

    - name: Display vm creation response
      debug:
        var: json_create_result